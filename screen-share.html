<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirShare - Private Screen Sharing</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --primary: #4f46e5; 
            --secondary: #10b981; 
            --danger: #ef4444;
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); 
            color: var(--text-main);
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 2rem 1rem; 
        }

        .control-card { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 2.5rem 2rem; 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 480px; 
            text-align: center; 
            margin-bottom: 2rem; 
            backdrop-filter: blur(10px);
        }

        .control-card h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--primary); }
        .control-card p.subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        .input-group { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        input { 
            padding: 0.85rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; 
            font-size: 1rem; background-color: #f9fafb; transition: all 0.2s ease;
        }
        input:focus { outline: none; border-color: var(--primary); background-color: #fff; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); }

        .btn-group { display: flex; flex-wrap: wrap; gap: 1rem; }
        button { 
            flex: 1; min-width: 140px; padding: 0.85rem; border: none; border-radius: 8px; 
            font-weight: 600; font-size: 0.95rem; cursor: pointer; color: white; transition: all 0.2s ease; 
        }
        button:active { transform: scale(0.97); }
        button:hover { filter: brightness(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-host { background-color: var(--primary); }
        .btn-join { background-color: var(--secondary); }
        .btn-stop { background-color: var(--danger); display: none; width: 100%; margin-top: 1rem; }

        .status-badge { 
            display: inline-block; padding: 0.4rem 1rem; border-radius: 9999px; 
            font-size: 0.85rem; font-weight: 500; margin-top: 1.5rem; 
            background: #e5e7eb; color: var(--text-muted); transition: all 0.3s ease;
        }
        .status-live { background: #def7ec; color: #03543f; animation: pulse 2s infinite; }
        .status-error { background: #fde8e8; color: #9b1c1c; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .video-container {
            width: 100%; max-width: 1000px; position: relative;
        }

        .video-wrapper { 
            width: 100%; aspect-ratio: 16 / 9; background: #111827; border-radius: 16px; 
            overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        
        video { width: 100%; height: 100%; object-fit: contain; display: none; }
        
        .placeholder-text { 
            color: #4b5563; font-size: 1.1rem; position: absolute; 
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .placeholder-text svg { width: 48px; height: 48px; opacity: 0.5; }

        .btn-fullscreen {
            position: absolute; bottom: 15px; right: 15px; background: rgba(0, 0, 0, 0.6); 
            color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 12px; 
            border-radius: 6px; cursor: pointer; display: none; backdrop-filter: blur(4px);
            font-size: 0.85rem; min-width: auto;
        }
        .btn-fullscreen:hover { background: rgba(0, 0, 0, 0.8); }

    </style>
</head>
<body>

    <div class="control-card">
        <h1>AirShare</h1>
        <p class="subtitle">Simple, peer-to-peer screen sharing.</p>
        
        <div class="input-group">
            <input type="text" id="roomName" placeholder="Room ID (e.g., team-sync)">
            <input type="password" id="password" placeholder="Passcode">
        </div>
        
        <div class="btn-group">
            <button class="btn-host" id="hostBtn">Share Screen</button>
            <button class="btn-join" id="joinBtn">Join as Viewer</button>
        </div>

        <button class="btn-stop" id="stopBtn">Stop / Disconnect</button>

        <div id="statusBadge" class="status-badge">Waiting for action...</div>
    </div>

    <div class="video-container">
        <div class="video-wrapper" id="videoWrapper">
            <div class="placeholder-text" id="placeholder">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <span>Screen will appear here</span>
            </div>
            <video id="displayVideo" autoplay playsinline></video>
        </div>
        <button class="btn-fullscreen" id="fullscreenBtn">â›¶ Full Screen</button>
    </div>

    <script>
        let peer = null;
        let screenStream = null;
        
        const ui = {
            statusBadge: document.getElementById('statusBadge'),
            video: document.getElementById('displayVideo'),
            placeholder: document.getElementById('placeholder'),
            hostBtn: document.getElementById('hostBtn'),
            joinBtn: document.getElementById('joinBtn'),
            stopBtn: document.getElementById('stopBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            videoWrapper: document.getElementById('videoWrapper')
        };

        function updateStatus(text, type = 'default') {
            ui.statusBadge.innerText = text;
            ui.statusBadge.className = 'status-badge'; 
            if (type === 'live') ui.statusBadge.classList.add('status-live');
            if (type === 'error') ui.statusBadge.classList.add('status-error');
        }

        function setVideoActive(isActive, stream = null) {
            if (isActive) {
                ui.video.srcObject = stream;
                ui.video.style.display = 'block';
                ui.placeholder.style.display = 'none';
                ui.stopBtn.style.display = 'block';
                ui.fullscreenBtn.style.display = 'block';
                ui.hostBtn.disabled = true;
                ui.joinBtn.disabled = true;
            } else {
                ui.video.srcObject = null;
                ui.video.style.display = 'none';
                ui.placeholder.style.display = 'flex';
                ui.stopBtn.style.display = 'none';
                ui.fullscreenBtn.style.display = 'none';
                ui.hostBtn.disabled = false;
                ui.joinBtn.disabled = false;
            }
        }

        function generatePeerId() {
            const room = document.getElementById('roomName').value.trim();
            const pass = document.getElementById('password').value.trim();
            if (!room || !pass) {
                updateStatus("Please enter Room ID and Passcode!", "error");
                return null;
            }
            return `airshare_${room}_${pass}`;
        }

        // Clean up connection & reset UI
        function disconnect() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            if (peer) {
                peer.destroy();
                peer = null;
            }
            setVideoActive(false);
            updateStatus("Disconnected.");
        }

        // Stop / Disconnect Button Logic
        ui.stopBtn.onclick = disconnect;

        // Fullscreen Logic
        ui.fullscreenBtn.onclick = () => {
            if (ui.video.requestFullscreen) {
                ui.video.requestFullscreen();
            } else if (ui.video.webkitRequestFullscreen) { /* Safari */
                ui.video.webkitRequestFullscreen();
            } else if (ui.video.msRequestFullscreen) { /* IE11 */
                ui.video.msRequestFullscreen();
            }
        };

        // --- Host Logic ---
        ui.hostBtn.onclick = async () => {
            const peerId = generatePeerId();
            if (!peerId) return;

            updateStatus("Requesting screen permission...");

            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                setVideoActive(true, screenStream);
                
                peer = new Peer(peerId);

                peer.on('open', () => {
                    updateStatus("ðŸŸ¢ Sharing live... Waiting for viewers", "live");
                });

                peer.on('call', (call) => {
                    call.answer(screenStream);
                });

                peer.on('error', (err) => {
                    if (err.type === 'id-taken') {
                        updateStatus("Room is already in use by a host.", "error");
                        disconnect();
                    } else {
                        updateStatus("Error: " + err.type, "error");
                        disconnect();
                    }
                });

                // Handle browser's native "Stop Sharing" button
                screenStream.getVideoTracks()[0].onended = () => {
                    updateStatus("Sharing ended by host.");
                    disconnect();
                };

            } catch (err) {
                updateStatus("Permission denied or cancelled.", "error");
                disconnect();
            }
        };

        // --- Viewer Logic ---
        ui.joinBtn.onclick = () => {
            const hostId = generatePeerId();
            if (!hostId) return;

            updateStatus("Connecting to room...");
            peer = new Peer();

            peer.on('open', () => {
                const call = peer.call(hostId, null);

                if (!call) {
                    updateStatus("Host not found. Check ID/Passcode.", "error");
                    disconnect();
                    return;
                }

                call.on('stream', (remoteStream) => {
                    setVideoActive(true, remoteStream);
                    updateStatus("ðŸŸ¢ Connected. Watching screen.", "live");
                });
                
                // When host stops sharing
                call.on('close', () => {
                    updateStatus("Host disconnected.", "error");
                    disconnect();
                });
            });

            peer.on('error', () => {
                updateStatus("Connection failed.", "error");
                disconnect();
            });
        };
    </script>
</body>
</html>
